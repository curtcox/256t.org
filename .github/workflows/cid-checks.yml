name: CID Checks

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  python:
    name: Python CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Run Python CID check
        run: python implementations/python/check.py

  javascript:
    name: JavaScript CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run JavaScript CID check
        run: node implementations/javascript/check.js

  node:
    name: Node CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run Node CID check
        run: node implementations/node/check.mjs

  typescript:
    name: TypeScript CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install TypeScript runner
        run: npm install --no-save --no-package-lock tsx typescript
      - name: Run TypeScript CID check
        run: npx tsx implementations/typescript/check.ts

  deno:
    name: Deno CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      - name: Run Deno CID check
        run: deno run --allow-read --allow-net implementations/deno/check.ts

  ecmascript:
    name: ECMAScript CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install node-fetch
        run: cd implementations/ecmascript && npm install --no-save node-fetch
      - name: Run ECMAScript CID check
        run: cd implementations/ecmascript && node check.js

  java:
    name: Java CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Compile CID checker
        run: javac implementations/java/*.java
      - name: Run Java CID check
        run: java -cp implementations/java Check

  groovy:
    name: Groovy CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Groovy
        run: sudo apt-get update && sudo apt-get install -y groovy
      - name: Run Groovy CID check
        run: groovy -cp implementations/groovy implementations/groovy/check.groovy

  haskell:
    name: Haskell CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Haskell toolchain
        run: sudo apt-get update && sudo apt-get install -y ghc cabal-install libghc-cryptonite-dev libghc-memory-dev
      - name: Install Haskell dependencies
        run: |
          cabal update
          cabal install --lib cryptonite memory
      - name: Run Haskell CID check
        working-directory: implementations/haskell
        run: |
          ghc -i. -outputdir dist -package bytestring -package cryptonite -package memory -package filepath -package directory check.hs -o cid-check
          ./cid-check

  kotlin:
    name: Kotlin CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Kotlin
        run: sudo apt-get update && sudo apt-get install -y kotlin
      - name: Compile Kotlin CID checker
        run: kotlinc implementations/kotlin/Check.kt -include-runtime -d implementations/kotlin/check.jar
      - name: Run Kotlin CID check
        run: java -jar implementations/kotlin/check.jar

  scala:
    name: Scala CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Scala
        run: sudo apt-get update && sudo apt-get install -y scala
      - name: Compile Scala CID checker
        run: scalac -d implementations/scala implementations/scala/*.scala
      - name: Run Scala CID check
        run: scala -cp implementations/scala Check

  go:
    name: Go CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Run Go CID check
        working-directory: implementations/go
        run: go run .

  dart:
    name: Dart CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Install Dart dependencies
        working-directory: implementations/dart
        run: dart pub get
      - name: Run Dart CID check
        working-directory: implementations/dart
        run: dart run check.dart

  elixir:
    name: Elixir CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18'
          otp-version: '27.0'
      - name: Run Elixir CID check
        run: elixir implementations/elixir/check.exs

  erlang:
    name: Erlang CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Erlang
        run: sudo apt-get update && sudo apt-get install -y erlang
      - name: Compile Erlang CID checker
        run: erlc -o implementations/erlang implementations/erlang/*.erl
      - name: Run Erlang CID check
        run: erl -noshell -pa implementations/erlang -s check run -s init stop

  julia:
    name: Julia CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'
      - name: Install Julia dependencies
        run: julia -e 'using Pkg; Pkg.add("HTTP")'
      - name: Run Julia CID check
        run: julia implementations/julia/check.jl

  lua:
    name: Lua CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Lua
        run: sudo apt-get update && sudo apt-get install -y lua5.4
      - name: Run Lua CID check
        run: lua implementations/lua/check.lua

  crystal:
    name: Crystal CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Crystal
        run: sudo apt-get update && sudo apt-get install -y crystal
      - name: Run Crystal CID check
        run: crystal run implementations/crystal/check.cr

  csharp:
    name: C# CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Run C# CID check
        run: dotnet run --configuration Release --project implementations/csharp -- check

  fsharp:
    name: F# CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Run F# CID check
        run: dotnet fsi implementations/fsharp/check.fsx

  cpp:
    name: C++ CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build C++ CID checker
        run: g++ -std=c++17 implementations/cpp/check.cpp -o implementations/cpp/check -lcrypto
      - name: Run C++ CID check
        run: ./implementations/cpp/check

  rust:
    name: Rust CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run Rust CID check
        working-directory: implementations/rust
        run: cargo run --release --quiet

  swift:
    name: Swift CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Swift CID check
        run: docker run --rm -v "$PWD":/workspace -w /workspace swift:5.10 bash -lc "swiftc implementations/swift/cid.swift implementations/swift/check.swift -o implementations/swift/check && implementations/swift/check"

  ruby:
    name: Ruby CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      - name: Run Ruby CID check
        run: ruby implementations/ruby/check.rb

  php:
    name: PHP CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
      - name: Run PHP CID check
        run: php implementations/php/check.php

  racket:
    name: Racket CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Racket
        run: sudo apt-get update && sudo apt-get install -y racket
      - name: Run Racket CID check
        run: racket implementations/racket/check.rkt

  r:
    name: R CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-r@v2
      - name: Install R dependencies
        run: |
          Rscript -e "install.packages(c('digest','base64enc','httr'), repos='https://cloud.r-project.org/', lib=.libPaths()[1], dependencies=TRUE)"
          Rscript -e "cat('Library paths:\n'); print(.libPaths())"
          Rscript -e "cat('\nInstalled packages:\n'); print(installed.packages()[,c('Package','Version','LibPath')])"
      - name: Run R CID check
        run: Rscript implementations/r/check.R

  perl:
    name: Perl CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Perl dependencies
        run: sudo cpan -i LWP::UserAgent LWP::Protocol::https
      - name: Run Perl CID check
        run: perl implementations/perl/check.pl

  prolog:
    name: Prolog CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install SWI-Prolog
        run: sudo apt-get update && sudo apt-get install -y swi-prolog
      - name: Run Prolog CID check
        run: swipl -q -f implementations/prolog/check.pl

  emacs-lisp:
    name: Emacs Lisp CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Emacs
        run: sudo apt-get update && sudo apt-get install -y emacs-nox
      - name: Run Emacs Lisp CID check
        run: emacs --batch -l implementations/emacs-lisp/check.el

  powershell:
    name: PowerShell CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run PowerShell CID check
        run: pwsh implementations/powershell/check.ps1

  bash:
    name: Bash CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Bash CID check
        run: bash implementations/bash/check.sh

  tcl:
    name: Tcl CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Tcl
        run: sudo apt-get update && sudo apt-get install -y tcl
      - name: Run Tcl CID check
        run: tclsh implementations/tcl/check.tcl

  clojure:
    name: Clojure CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Install Clojure CLI
        run: |
          curl -O https://download.clojure.org/install/linux-install.sh
          chmod +x linux-install.sh
          sudo ./linux-install.sh
      - name: Run Clojure CID check
        run: clojure -M -m implementations.clojure.check

  nim:
    name: Nim CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: iffy/install-nim@v5
        with:
          version: 'stable'
      - name: Install Nim dependencies
        run: nimble install nimcrypto -y
      - name: Run Nim CID check
        run: nim compile --run implementations/nim/main.nim check

  ocaml:
    name: OCaml CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install OCaml dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y opam m4 pkg-config
          opam init -y --disable-sandboxing
          opam switch create . ocaml-base-compiler.5.1.1 -y
          opam install -y ocamlfind digestif base64
      - name: Build OCaml CID checker
        run: opam exec --switch=. -- ocamlfind ocamlopt -package digestif.c,base64 -linkpkg -I implementations/ocaml implementations/ocaml/cid.ml implementations/ocaml/check.ml -o implementations/ocaml/check
      - name: Run OCaml CID check
        run: opam exec --switch=. -- implementations/ocaml/check

  c:
    name: C CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build C CID checker
        run: gcc -std=c11 implementations/c/check.c implementations/c/cid.c -o implementations/c/check -lcrypto
      - name: Run C CID check
        run: ./implementations/c/check

  cmake:
    name: CMake CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run CMake CID check
        run: cmake -P implementations/cmake/check.cmake

  zig:
    name: Zig CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: 0.13.0
      - name: Build and run Zig CID check
        working-directory: implementations/zig
        run: zig build run

  d:
    name: D CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install D compiler
        uses: dlang-community/setup-dlang@v1
        with:
          compiler: ldc-latest
      - name: Build D CID checker
        run: ldc2 implementations/d/check.d implementations/d/cid.d -of=implementations/d/check
      - name: Run D CID check
        run: implementations/d/check

  fortran:
    name: Fortran CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Fortran compiler
        run: sudo apt-get update && sudo apt-get install -y gfortran
      - name: Build Fortran CID checker
        run: gfortran implementations/fortran/check.f90 -o implementations/fortran/check
      - name: Run Fortran CID check
        run: implementations/fortran/check

  unison:
    name: Unison CID check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Unison
        run: |
          mkdir -p ~/.local/bin
          curl -L https://github.com/unisonweb/unison/releases/download/release%2FM6j/ucm-linux.tar.gz -o /tmp/ucm.tar.gz
          tar -xzf /tmp/ucm.tar.gz -C ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Run Unison CID check
        run: |
          cd implementations/unison
          ucm run check.u
