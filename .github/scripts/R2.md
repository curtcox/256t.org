# 256t.org R2 Upload Scripts

This directory contains scripts for uploading content to the Cloudflare R2 bucket that backs 256t.org.

## Overview

The bucket `256t-cids` hosts both:
- **CID files**: Content-addressable storage files (uploaded by `r2_upload.py`)
- **Static site files**: Generated website files (uploaded by `r2_static_upload.py`)

Both scripts use Cloudflare's Wrangler CLI for all R2 operations.

## Scripts

### r2_upload.py - CID File Upload

Implements content-addressable storage using CIDs (Content Identifiers) as object keys in R2.

### r2_static_upload.py - Static Site Upload

Uploads all static website files from the `dist/` directory to R2 with appropriate content types and cache headers.

## Installation

The script requires Wrangler CLI (installed via npm):

```bash
npm install -g wrangler
# or use npx wrangler for one-time execution
```

## Usage

### Upload a CID file

```bash
python .github/scripts/r2_upload.py examples/hello.txt
```

### Verify an existing CID object

```bash
python .github/scripts/r2_upload.py examples/hello.txt --verify-only
```

### Upload static site files

```bash
python .github/scripts/r2_static_upload.py dist
```

The bucket name `256t-cids` is hardcoded in both scripts.

## Configuration

The script uses Wrangler for authentication with Cloudflare R2. You'll need:
- `CLOUDFLARE_ACCOUNT_ID`: Your Cloudflare account ID
- `CLOUDFLARE_API_TOKEN`: A Cloudflare API token with R2 read/write permissions

These can be set as environment variables or Wrangler will prompt for authentication.

## Upload Behavior

When uploading a file, the script:

1. **Computes the CID** from the file content
2. **Checks if the object exists** by attempting to download it
3. **Verifies content** if object exists:
   - If downloaded content's CID matches: Skip upload (already valid)
   - If CID doesn't match: Error (integrity violation)
4. **Uploads the object** if it doesn't exist using Wrangler:

```bash
wrangler r2 object put 256t-cids/{cid} \
  --file {filepath} \
  --cache-control "public, max-age=31536000, immutable" \
  --content-type "application/octet-stream"
```

## Verification Process

The script verifies objects by:

1. **Downloading the object** using Wrangler:
   ```bash
   wrangler r2 object get 256t-cids/{cid} --file /tmp/downloaded
   ```
2. **Computing the CID** from the downloaded content
3. **Comparing** the computed CID with the expected CID

If they match, the object is valid. If not, there's an integrity violation.

## Cache Settings

All uploaded objects use the following cache settings:

```
Cache-Control: public, max-age=31536000, immutable
```

This instructs clients to cache the content indefinitely since CID-addressed content is immutable.

## CI/CD Integration (GitHub Actions)

To use this script in GitHub Actions, you need to configure the following secrets in your repository:

### Required GitHub Secrets

1. **CLOUDFLARE_ACCOUNT_ID**: Your Cloudflare account ID
2. **CLOUDFLARE_API_TOKEN**: A Cloudflare API token with R2 read/write permissions

### Setting Up GitHub Secrets

1. Go to your repository's Settings → Secrets and variables → Actions
2. Click "New repository secret"
3. Add each of the required secrets

### Workflow Configuration

The `r2-upload.yml` workflow uses these secrets to authenticate with Cloudflare:

```yaml
- name: Upload to R2
  env:
    CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  run: |
    npm install -g wrangler
    python .github/scripts/r2_upload.py examples/hello.txt
```

## Validation Guidelines

When validating CID objects:

1. **Download the object** from R2
2. **Compute the CID** from the downloaded content
3. **Compare** with the expected CID
4. **Note**: This method requires downloading the entire object but ensures integrity

## Error Handling

The script handles several error conditions:

- **Content mismatch**: Downloaded content's CID doesn't match expected CID (error - integrity violation)
- **Object not found**: Proceeds with upload (normal)
- **Upload failure**: Reports error and exits with non-zero status

## Troubleshooting

### "Content CID mismatch"

This indicates a serious integrity issue where an object exists with a CID key but the content doesn't match the expected CID. This should never happen in normal operation.

### Authentication Errors

Ensure your Cloudflare credentials are properly configured:
- Check `CLOUDFLARE_ACCOUNT_ID` environment variable
- Check `CLOUDFLARE_API_TOKEN` environment variable
- Verify the API token has R2 read/write permissions
- Ensure the token is not expired

## Development

### Testing Locally

To test the script locally:

1. Install Wrangler: `npm install -g wrangler`
2. Authenticate with Cloudflare: `wrangler login`
3. Set your account ID: `export CLOUDFLARE_ACCOUNT_ID=your-account-id`
4. Run the script: `python .github/scripts/r2_upload.py examples/hello.txt`

Note: Wrangler also supports local R2 development with `--local` flag, but this script is designed for remote R2 buckets.

## References

- [256t.org Specification](../../README.md)
- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [Wrangler CLI Documentation](https://developers.cloudflare.com/workers/wrangler/)
- [Wrangler R2 Commands](https://developers.cloudflare.com/workers/wrangler/commands/#r2)
- [RFC 4648 - Base64url Encoding](https://datatracker.ietf.org/doc/html/rfc4648#section-5)
